from flask import Flask, render_template, send_from_directory, request, jsonify
from flask_caching import Cache
import os
import re
import logging
from werkzeug.exceptions import NotFound
from datetime import datetime
from config import get_config

# Получаем конфигурацию
config_class = get_config()

# Настройка логирования
log_dir = config_class.LOG_DIR
os.makedirs(log_dir, exist_ok=True)

logging.basicConfig(
    level=getattr(logging, config_class.LOG_LEVEL),
    format=config_class.LOG_FORMAT,
    handlers=[
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# Инициализация Flask приложения
app = Flask(__name__, static_folder='static', static_url_path='/static')
app.config.from_object(config_class)

# Настройка кэширования
cache_config = {
    'CACHE_TYPE': config_class.CACHE_TYPE,
    'CACHE_DEFAULT_TIMEOUT': config_class.CACHE_DEFAULT_TIMEOUT,
    'CACHE_THRESHOLD': getattr(config_class, 'CACHE_THRESHOLD', 1000)
}
cache = Cache(app, config=cache_config)

# Убедимся, что директория для загрузки существует
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

# Specialists data (in correct order: 1. Дмитрий Михайлович, 2. Любовь Владимировна, 3. Юлия Геннадиевна)
SPECIALISTS = {
    'ivashinenko-dmitriy-mikhaylovich': {
        'id': 'ivashinenko-dmitriy-mikhaylovich',
        'full_name': 'Ивашиненко Дмитрий Михайлович',
        'position': 'Психиатр, Психотерапевт',
        'career_start_year': 2001,
        'clinic_start_date': '2024-04-01',
        'photo': 'ivashinenko.jpg',
        'dikidi_url': 'https://dikidi.app/ru/profile/centr_psixoterapii_i_psixologicheskogo_konsultirovaniya_krylya_1806947/master/3882377',
        'description': '''
            <p>Кандидат медицинских наук, доцент. Специальность: врач-психиатр, врач-психотерапевт со стажем работы 24 года.</p>
            <p>В 2003 году решением диссертационного совета Рязанского государственного медицинского университета им. акад. И.П. Павлова присуждена учёная степень кандидата медицинских наук. В 2017 году присвоено учёное звание доцента по специальности «Психиатрия».</p>
        ''',
        'education': [
            'Специалитет «Лечебное дело», Рязанский государственный медицинский университет им. акад. И.П. Павлова, 2000 г.',
            'Интернатура по специальности «Психиатрия», 2001 г.',
            'Специальность «Психотерапия», Смоленская государственная медицинская академия, 2007 г.',
            'Специальность «Психиатрия-наркология», Смоленская государственная медицинская академия, 2009 г.',
            '«Психотерапия с основами психоанализа», Рязанский государственный медицинский университет им. акад. И.П. Павлова, 2022 г.',
            '«Депрессивные, тревожные и соматоформные расстройства в психиатрии и общей медицине», РНИМУ им. Н.И. Пирогова, 2021 г.',
            '«Детская и подростковая аддиктология», Национальный медицинский исследовательский центр психиатрии и психологии им. В.П. Сербского, 2021 г.'
        ],
        'work_experience': [
            'С 2001 года работает в Тульской областной клинической психиатрической больнице им. Н.П. Каменева, с 2019 года занимает должность заместителя главного врача по лечебной работе',
            'С 2005 года совмещал лечебную деятельность с педагогической работой в Тульском государственном университете. В 2012 году активно участвовал в создании кафедры психиатрии и наркологии, которую на протяжении многих лет возглавлял',
            'Является организатором международной научно-практической конференции, посвящённой Всемирному дню психического здоровья'
        ],
        'specializations': [
            'Аффективные расстройства',
            'Депрессии различной степени тяжести',
            'Биполярное аффективное расстройство',
            'Шизофрения, расстройства шизофренического спектра',
            'Расстройства личности',
            'Расстройства пищевого поведения',
            'Обсессивно-компульсивное расстройство'
        ],
        'problems': [
            'Аффективные расстройства',
            'Депрессии различной степени тяжести',
            'Биполярное аффективное расстройство',
            'Шизофрения, расстройства шизофренического спектра',
            'Расстройства личности, в том числе пограничное расстройство личности',
            'Расстройства пищевого поведения',
            'Обсессивно-компульсивное расстройство',
            'Психические расстройства при органических заболеваниях головного мозга, эпилепсии',
            'Деменции различной этиологии',
            'Психосоматическая патология, неврозы',
            'Нарушения сна',
            'Тревога, страхи, панические атаки',
            'Психосоматические расстройства',
            'Навязчивые состояния (мысли, действия)',
            'Неконтролируемая агрессия',
            'Реакции на стресс'
        ]
    },
    'ivashinenko-lyubov-vladimirovna': {
        'id': 'ivashinenko-lyubov-vladimirovna',
        'full_name': 'Ивашиненко Любовь Владимировна',
        'position': 'Психолог',
        'career_start_year': 2003,
        'clinic_start_date': '2024-04-01',
        'photo': 'ivashinenko-lyubov.jpg',
        'dikidi_url': 'https://dikidi.app/ru/profile/centr_psixoterapii_i_psixologicheskogo_konsultirovaniya_krylya_1806947/master/3882347',
        'description': '''
            <p><strong>Ивашиненко Любовь Владимировна</strong> — клинический психолог, сексолог, транзактный аналитик, CTA(p). Член ЕАТА, СОТА, главный внештатный педагог-психолог Тулы и Тульской области.</p>

            <p>Опыт работы психологом 21 год. Имею многочисленные дипломы и сертификаты о повышениях квалификации. Системно прохожу обучение, личную терапию и супервизии.</p>

            <h3>Профессиональная философия</h3>
            <p>В своей работе опираюсь на принципы: честности, безопасности, бережности и надежности.</p>
            <p>Мое профессиональное кредо - психотерапия с любовью.</p>

            <h3>Профессиональные сообщества</h3>
            <p>Член EATA (Европейская Ассоциация Трансактного Анализа), СОТА (Санкт-Петербуржская Организация Трансактного Анализа)</p>

            <h3>Подход к работе</h3>
            <p>Это лишь часть причин, по которым вы можете ко мне обратиться. Если вы в тупике и не знаете, что делать - приходите, вместе мы трансформируем тупик в понятный и осмысленный путь.</p>
        ''',
        'education': [
            'В 2004г. окончила ГОУ ВПО «Тульский государственный университет». Квалификация: Психолог. Преподаватель психологии по специальности «психология»',
            '2014 - 2016 – переподготовка по клинической психологии в ФГБУ СПб НИПНИ им. В.М. Бехтерева. Квалификация: Клинический психолог',
            '2003 г. – семинар-тренинг «Психологическое консультировании (позиция консультанта и практические аспекты работы)», Тула, Центр социально-психологической помощи молодежи «Шанс» - 24 часа',
            '2003 г. – программа телесно-ориентированной психотерапии «Введение в Систему целостного движения», Тула, Центр психологической профилактики и реабилитации «Валеоцентр» - 18 часов',
            '2003 г. – семинар-тренинг «Индивидуальная и групповая коррекционная работа со взрослыми и подростками», Тула, Центр социально-психологической помощи молодежи «Шанс» - 24 часа',
            '2004 г. – тренинг «Основы телефонного консультирования», Тула, Центр социально-психологической помощи молодежи «Шанс» - 40 часов',
            '2005 г. – семинар-тренинг «Основные трудности психологического консультирования: проблемы влияния, доверия, баланса ответственности», Тула, Центр социально-психологической помощи молодежи «Шанс» - 24 часа',
            '2005 г. – семинар-тренинг «Психологическая коррекция: основные принципы, базовые техники и приемы», Тула, Центр социально-психологической помощи молодежи «Шанс» - 24 часа',
            '2006 г. – курс повышения квалификации «Психологические и медицинские аспекты профессиональной деятельности», ГОУ ДПО МАПО – 144 часа',
            '2006 г. – «Основы гештальт-терапии», Московский институт гештальт-терапии – 30 часов',
            '2008 г. – «Юнгианский анализ», Московский институт практической психологии и психотерапии – 16 часов',
            '2008 г. – Социальные, психологические и психофизиологические механизмы и профилактика зависимого (аддиктивного) поведения, НГОУ ДПО «Институт практической психологии «Иматон»» - 16 часов',
            '2008 – 2011 гг. – Символодрама 1, 2, 3 ступень, МОКПО МОО СРС – 146 часов',
            '2010 г. – Психотерапия неврозов: клиника, диагностка, лечение, Санкт-Петербург, Научно-исследовательский институт им. Бехтерева – 72 часа',
            '2010 г. – Интенсивная семейная терапия на дому, МГППУ – 120 часов',
            '2010 г. – НЛП-практик, Смоленский медицинский университет',
            '2012 г. – Современные подходы и тенденции профилактики наркомании в молодёжной среде, НОУ «Межрегиональный информационный экономико-правовой центр» - 72 часа',
            '2013 г. – краткосрочное повышение квалификации по программе «Технологии профилактики суицидального поведения студентов вузов», ФГАОУ ВПО «Северо-Кавказкий федеральный университет» - 72 часа',
            '2013 г. – практикум на предприятии-изготовителе ООО НПКФ «Медиком МТД» по эксплуатации и обслуживанию следующего оборудования: «Реакор-Т», «Эгоскоп»',
            '2015 г. – организация образовательного процесса для обучения инвалидов и лиц с ограниченными возможностями здоровья в образовательных организациях: правовой, психолого-педагогический, социальный и медицинский аспекты, АНО ДПО «Институт развития новых медицинских технологий» - 72 часа',
            '2015 г. – «Экзистенциальная психотерапия и консультирование» Институт практической психологии «Иматон», Санкт-Петербург – 80 часов',
            '2018 г. – 101 курс по трансактному анализу',
            '2019 – по настоящий момент – Четырехлетняя программа обучения и подготовки к экзамену по Трансакционному Анализу (ТА) в области психотерапии и психологического консультирования'
        ],
        'work_experience': [
            '2003–2005 гг. — психолог-консультант службы «Телефон доверия»',
            '2005–2008 гг. — педагог-психолог «Медико-социальной службы планирования семьи для студентов и учащейся молодежи» Департамента Тульской области по молодежной политике',
            'С 2007 г. — преподаватель Тульского государственного университета, Медицинский институт, кафедра психиатрии и наркологии. Читаемые дисциплины: «Психология и педагогика», «Психология индивидуальных различий», «Клиническая психология»',
            'С 2011 г. — директор Службы психолого-педагогической помощи студентам ТулГУ. Инициатор и организатор создания Службы, разработала концепцию работы СППС',
            'С декабря 2022 г. — организатор работы Федеральной горячей линии по оказанию психологической помощи студентам Минобрнауки России на базе Тульского государственного университета',
            'Активно участвует в научно-практических конференциях, посвященных вопросам психического здоровья. Опубликовано 23 статьи в психологических сборниках и журналах',
            'В 2012 г. заняла первое место в конкурсе грантов ректора для молодых ученых'
        ],
        'specializations': [
            'Клиническая психология',
            'Сексология',
            'Транзактный анализ',
            'Психотерапия',
            'Семейная терапия',
            'Телефонное консультирование',
            'Гештальт-терапия',
            'Юнгианский анализ',
            'Экзистенциальная психотерапия',
            'Символодрама',
            'НЛП (нейролингвистическое программирование)',
            'Работа с суицидальным поведением',
            'Профилактика зависимостей'
        ],
        'problems': [
            'Если в вашей жизни происходит ситуация, с которой вы не справляетесь эмоционально',
            'Если вы испытываете трудности в отношениях или не можете начать отношения',
            'Если вы переживаете разрыв, измену, горе или другие серьезные изменения в вашей жизни',
            'Если вы находитесь в созависимых или абьюзивных отношениях',
            'Если вы проходите личный кризис (как было - не устраивает, как по новому - не понятно)',
            'Если вы сталкиваетесь с последствиями травматического опыта (ПТСР и КПТСР)',
            'Если вы страдаете от низкой самооценки и изъедаете себя критикой',
            'Если вы испытываете тревогу, панические атаки, страхи, вас преследуют навязчивые мысли или воспоминания',
            'Если вы имеете психосоматический диагноз',
            'Если вы не видите смысла или не хотите жить дальше',
            'Если вы имеете проблемы сексуального характера, не дружите со своей сексуальностью, не принимаете свое тело'
        ]
    },
    'ershova-yuliya-gennadievna': {
        'id': 'ershova-yuliya-gennadievna',
        'full_name': 'Ершова Юлия Геннадиевна',
        'position': 'Психотерапевт',
        'career_start_year': 2010,
        'clinic_start_date': '2024-10-01',
        'photo': 'ershova.jpg',
        'dikidi_url': 'https://dikidi.app/ru/profile/centr_psixoterapii_i_psixologicheskogo_konsultirovaniya_krylya_1806947/master/3882373',
        'description': '''
            <p><strong>Ершова Юлия Геннадиевна</strong> — врач-психиатр, психотерапевт с более чем 15-летним опытом работы.</p>

            <p>Специализируюсь на лечении тревожных, депрессивных расстройств, расстройств пищевого поведения. 10 лет жила и работала в Европе по специальности. Имею нострификации дипломов по стандартам ЕС. Занимаюсь когнитивно-поведенческой терапией.</p>

            <h3>Международный опыт</h3>
            <p>Имею богатый опыт работы в европейских медицинских учреждениях и регулярно выступаю на международных конгрессах.</p>

            <h3>Профессиональный подход</h3>
            <p>Использую Схемотерапию  и доказательные методы когнитивно-поведенческой терапии для эффективного лечения расстройств настроения и пищевого поведения.</p>
        ''',
        'education': [
            'Тульский Государственный Университет (лечебный факультет)',
            'Интернатура по специальности психиатрия в Московской Медицинской Академии им. Сеченова',
            'Повышение квалификации по специальности психотерапия в Смоленской Медицинской Академии',
            'Повышение квалификации в направлении Трансактный анализ в Европейском обществе Трансактного Анализа, Москва',
            'Повышение квалификации в направлении Когнитивно-Поведенческая Терапия, Братислава, Словакия'
        ],
        'work_experience': [
            'Работала врачом-психиатром в Тульской Областной Психиатрической Больнице на протяжении 5 лет',
            'Работала больше 9 лет в Центре для лечения зависимостей, г. Банская Быстрица, Словакия. Отделение и амбуланция',
            'Консультирую на протяжении 6 лет в рамках частной практики онлайн',
            'Практикую в Центре Психологического консультирования и Психотерапии «Крылья», г. Тула, Бундурина 40',
            'Регулярно выступаю на Международных Европейских Конгрессах (6 выступлений)'
        ],
        'specializations': [
            'Когнитивно-поведенческая терапия',
            'Схемотерапия',
            'Психиатрия',
            'Психотерапия',
            'Трансактный анализ',
            'Тревожные расстройства',
            'Депрессивные расстройства',
            'Расстройства пищевого поведения',
            'Посттравматическое стрессовое расстройство',
            'Лечение зависимостей'
        ],
        'problems': [
            'Тревожные расстройства: Панические атаки, Генерализованное тревожное расстройство, Социальное тревожное расстройство, Изолированные фобии',
            'Депрессии, обусловленные влиянием внешних и внутренних факторов. Смешанные депрессии',
            'Расстройство пищевого поведения: Эпизоды компульсивного переедания, эмоциональное переедание, скачки веса',
            'Посттравматическое стрессовое расстройство: Состояние, возникшее в результате перенесенных психологических травм и событий, связанных с угрозой для жизни',
            'Лечение зависимостей: алкогольная, наркотическая, игровая и другие виды зависимостей'
        ]
    },
    'krempovskaya-elizaveta-sergeevna': {
        'id': 'krempovskaya-elizaveta-sergeevna',
        'full_name': 'Кремповская Елизавета Сергеевна',
        'position': 'Психолог',
        'career_start_year': 2022,
        'clinic_start_date': '2024-10-01',
        'photo': 'krempovskaya.jpg',
        'dikidi_url': 'https://dikidi.app/ru/profile/centr_psixoterapii_i_psixologicheskogo_konsultirovaniya_krylya_1806947/master/3882367',
        'description': '''
            <p><strong>Кремповская Елизавета Сергеевна</strong> — возрастной психолог, оператор горячей линии экстренной психологической помощи. В работе использую интегративный подход, ориентируясь на индивидуальные потребности каждого человека.</p>

            <h3>Профессиональная философия</h3>
            <p>Нахожусь в долгосрочной личной и групповой терапии. Посещаю интервизорские и супервизорские группы на регулярной основе. Прохожу курсы повышения квалификации для предоставления качественной психологической помощи.</p>
        ''',
        'education': [
            '2022 г. – 2025 гг. – Тульский Государственный Университет, профиль - Детская и возрастная психология, квалификация – магистр психологии',
            '2022 г. – АНО ДПО «НАДПО», Профессиональная переподготовка, «Психосоматика и телесная психотерапия: теория, практика» 450 часов',
            '2023 г. – РУДН, Повышение квалификации, «Основы социального проектирования и публичных выступлений для специалистов, занимающихся профилактикой зависимого поведения среди молодёжи», 16 ак. ч.',
            '2023 г. – РУДН, Повышение квалификации, «Профилактическая работа в молодёжной среде: психологические аспекты отклоняющегося поведения», 18 ак. ч.',
            '2024 г. – Федеральный научный центр психологических и междисциплинарных исследований, «Основные методы психологического сопровождения при посттравматическом стрессовом расстройстве», 16 часов',
            '2024 г. – АНО ДПО «ИРПК», «Основы психотерапии и психологического консультирования», 144 часа',
            '2024 г. – АНО ДПО «НАДПО», «Психологическое консультирование зависимых и созависимых клиентов с использованием различных психотерапевтических подходов», 144 акад.ч.',
            '2025 г. – ФБГУ РАО, «Работа психолога с последствиями военной психологической травмы», 16 часов',
            '2025 г. – ТулГУ, Повышение квалификации, «Основы телефонного консультирования оператора горячей линии», 36 акад.ч.',
            '2025 г. – Институт психологии и психотерапии "MOST", Повышение квалификации, «Терапия инцеста», 16 акад. ч.'
        ],
        'work_experience': [
            '2021-2022 гг. – Тульский Государственный Университет, лаборант кафедры «Психиатрия и наркология»',
            '2022 г. – по настоящее время – Тульский Государственный Университет, педагог-психолог Службы психолого-педагогической помощи студентам',
            'С февраля 2022 г. – оператор Федеральной горячей линии по оказанию психологической помощи студентам Минобрнауки России на базе Тульского государственного университета',
            'Практика в центре "Крылья"',
            'Широкий спектр клиентских запросов: индивидуальное/семейное консультирование'
        ],
        'specializations': [
            'Детская и возрастная психология',
            'Психологическое консультирование'
        ],
        'problems': [
            'Кризисные состояния',
            'Тревога',
            'Проблемы с самооценкой',
            'Личностный кризис',
            'Конфликты в семье',
            'Одиночество, чувство изолированности',
            'Созависимость',
            'Апатия',
            'Неуверенность в себе',
            'Сложности во взаимоотношениях',
            'Зависимое поведение',
            'Импульсивное, агрессивное поведение',
            'Проблемы с социализацией/адаптацией'
        ]
    },
    'minaeva-alina-dmitrievna': {
        'id': 'minaeva-alina-dmitrievna',
        'full_name': 'Минаева Алина Дмитриевна',
        'position': 'Детский, Семейный психолог',
        'career_start_year': 2021,
        'clinic_start_date': '2024-01-01',
        'photo': 'minaeva.jpg',
        'dikidi_url': 'https://dikidi.app/ru/profile/centr_psixoterapii_i_psixologicheskogo_konsultirovaniya_krylya_1806947/master/3882369',
        'description': '''
            <p><strong>Минаева Алина Дмитриевна</strong> — квалифицированный детский и семейный психолог, преподаватель Тульского государственного университета.</p>

            <p>Моя миссия – помочь каждому ребенку раскрыть свой потенциал и научиться справляться с жизненными вызовами. Я специализируюсь на работе с детьми, подростками и их семьями, предлагая комплексный подход к решению психологических проблем.</p>

            <h3>Профессиональная философия</h3>
            <p>Работаю с детьми, подростками и их семьями, создавая безопасную и доверительную атмосферу для раскрытия внутреннего потенциала каждого ребенка и гармонизации семейных отношений.</p>

            <h3>Мой подход</h3>
            <p>• Индивидуальный подход к каждому клиенту<br>
            • Комплексное решение проблем<br>
            • Работа в безопасной и доверительной атмосфере<br>
            • Использование современных эффективных методик<br>
            • Регулярная обратная связь</p>

            <h3>Научная деятельность</h3>
            <p>Являюсь преподавателем ТулГУ и веду научную деятельность в области детской и возрастной психологии.</p>
        ''',
        'family_therapy_requests': [
            'Сложности с коммуникацией. Недопонимание, нежелание или неумение выражать свои эмоции, а также непродуктивные способы общения, такие как критика, уклонение от ответственности или обвинения.',
            'Проблемы доверия. Парная терапия может помочь восстановить доверие после предательства, неверности или других поведенческих проблем, которые повлияли на отношения.',
            'Проблемы с интимностью и сексуальностью в паре.',
            'Борьба с изменениями в жизни. Парная терапия может помочь партнёрам справиться с большими изменениями в их жизни, такими как переезд, потеря работы, болезнь или рождение детей.',
            'Преодоление чувства разобщённости.',
            'Мирное завершение отношений.'
        ],
        'education': [
            'ФГБОУ ВО ТулГУ 37.03.01 Психология, 2022',
            'ФГБОУ ВО ТулГУ 37.04.01 Психология (Детская и возрастная психология), 2024',
            'АНО «НАДПО» Арт-терапия в индивидуальном психологическом консультировании, 2022 г.',
            'АНО ВО «Восточно-европейский институт психоанализа» Системно-динамическая семейная и парная психотерапия, 2025 г.'
        ],
        'work_experience': [
            'Преподаватель Тульского государственного университета',
            'Ведение научной деятельности',
            'Практика в центре "Крылья"',
            'Консультации для родителей',
            'Проведение семейных сессий',
            'Обучение родительским навыкам',
            'Медиация конфликтов'
        ],
        'specializations': [
            'Детская психология',
            'Возрастная психология',
            'Семейная психотерапия',
            'Арт-терапия',
            'Системно-динамическая семейная и парная психотерапия',
            'Работа с детьми',
            'Работа с подростками',
            'Консультирование родителей',
            'Медиация семейных конфликтов',
            'Научная и преподавательская деятельность'
        ],
        'problems': [
            'Проблемы в школе (низкая мотивация, трудности с концентрацией)',
            'Эмоциональные трудности (тревожность, страхи, перепады настроения)',
            'Внутриличностные трудности (непринятие себя, самооценка, неуверенность в себе, выстраивание личных границ, самоопределение и самопознание)',
            'Поведенческие трудности (гиперактивность, агрессия)',
            'Проблемы в общении со сверстниками',
            'Семейные конфликты',
            'Травматический опыт',
            'Адаптация к изменениям в жизни (в том числе поддержка ребенка во время бракоразводного процесса)',
            'Детские страхи и тревожность',
            'Проблемы в детско-родительских отношениях',
            'Подростковый кризис',
            'Сложности в самоопределении у подростков'
        ]
    },
    'nosova-inna-evgenevna': {
        'id': 'nosova-inna-evgenevna',
        'full_name': 'Носова Инна Евгеньевна',
        'position': 'Психолог, Нейропсихолог',
        'career_start_year': 2023,
        'clinic_start_date': '2025-03-01',
        'photo': 'nosova.jpg',
        'dikidi_url': 'https://dikidi.app/ru/profile/centr_psixoterapii_i_psixologicheskogo_konsultirovaniya_krylya_1806947/master/3890626',
        'description': '''
            <p><strong>Носова Инна Евгеньевна</strong> — нейропсихолог Центра психотерапии и психологического консультирования «Крылья» с 20-летним профессиональным стажем.</p>

            <p>Новое направление в центре «Крылья»: нейродиагностика. Инна Евгеньевна представляет собой уникального специалиста, сочетающего богатый опыт в экономике и глубокие знания в области психологии.</p>

            <h3>Нейропсихологическая диагностика</h3>
            <p>После прохождения профессиональной подготовки по программе «Нейропсихология» в Московском институте психоанализа, Инна Евгеньевна ведёт практику нейропсихолога, специализируясь на нейропсихологической диагностике детей и взрослых. Такая диагностика позволяет оценить уровень развития высших психических функций — памяти, внимания, речи, восприятия и мышления — и дать точные рекомендации по дальнейшей коррекционной работе.</p>

            <h3>Профессиональный подход</h3>
            <p>В своей работе Инна Евгеньевна использует интегративный подход, опираясь на богатый профессиональный и практический опыт. Её отличает индивидуальный, мягкий и бережный стиль взаимодействия с клиентами, ориентированный на заботу и поддержку.</p>

            <h3>Специализированная помощь</h3>
            <p>Также специалист имеет опыт психологического сопровождения детей с ограниченными возможностями и проведения НейроЙоги в коррекционной работе с детьми и взрослыми.</p>
        ''',
        'education': [
            '1992 г. – Тульский политехнический институт, специальность «Экономика и организация машиностроительной промышленности»',
            '2005 г. – Российский государственный гуманитарный университет г. Москва, специальность «Психолог. Преподаватель психологии», диплом с отличием',
            'С 2005г. по настоящее время – повышение квалификации по программам: «Психолого-педагогическое сопровождение дистанционных образовательных проектов», «Психология управления», «Организация психолого-педагогического сопровождения в современной образовательной организации»',
            'Семинар-практикум по теме «НейроЙога в коррекционной работе с детьми и взрослыми»',
            'Регулярная супервизия',
            '2024 г. – профессиональная подготовка по программе «Нейропсихология» в НОЧУ ВО «Московский институт психоанализа», диплом с отличием представляет право на ведение профессиональной деятельности в сфере клинической нейропсихологии, нейропсихологической диагностики, реабилитации, коррекции и экспертизы',
            '2025 г. — Центр практической нейропсихологии, Семинар «Работа с движением в нейрореабилитации», объем 18 акад. часов, Сертификат',
            '2025 г. — АНО ДПО «Институт нейропсихологии и нейрофизиологии развития ребенка» (г. Москва), повышение квалификации по дополнительной профессиональной программе «Методы нейропсихологического обследования и коррекции детей в младшем школьном возрасте», 144 акад. часа',
            '2025 г. — ООО «Институт практической нейропсихологии и нейрореабилитации» (г. Москва), повышение квалификации по дополнительной профессиональной программе «Стажировки по нейропсихологической диагностике и коррекции», 144 акад. часа'
        ],
        'work_experience': [
            'С 2005 года – практическая работа психологом',
            'Регулярное повышение квалификации в области психологии и психолого-педагогического сопровождения',
            'Нейропсихологическая диагностика детей и взрослых',
            'Психологическое сопровождение детей с ограниченными возможностями',
            'Практика в центре "Крылья"',
            'Проведение НейроЙоги в коррекционной работе с детьми и взрослыми'
        ],
        'specializations': [
            'Нейропсихология',
            'Нейропсихологическая диагностика',
            'Клиническая нейропсихология',
            'Нейропсихологическая реабилитация',
            'Нейропсихологическая коррекция',
            'Нейропсихологическая экспертиза',
            'НейроЙога в коррекционной работе',
            'Психологическое сопровождение детей с ОВЗ',
            'Психолого-педагогическое сопровождение',
            'Организация образовательных проектов'
        ],
        'problems': [
            'Проблемы с высшими психическими функциями (память, внимание, речь, восприятие, мышление)',
            'Трудности в обучении у детей и взрослых',
            'Проблемы развития у детей',
            'Последствия черепно-мозговых травм',
            'Нарушения когнитивных функций',
            'Трудности с концентрацией внимания',
            'Проблемы с памятью',
            'Расстройства обучения',
            'Задержки речевого развития',
            'Проблемы с пространственным восприятием',
            'Трудности в организации деятельности',
            'Проблемы с планированием и самоконтролем',
            'Психологическое сопровождение детей с ограниченными возможностями',
            'Коррекция когнитивных нарушений у взрослых',
            'Диагностика готовности ребенка к школе'
        ]
    }
}

def format_text_with_line_breaks(text):
    """Format text with line breaks as HTML paragraphs"""
    if not text:
        return ""

    # Split by double line breaks to create separate paragraphs
    paragraphs = re.split(r'\n\s*\n', text.strip())

    formatted_text = ""
    for paragraph in paragraphs:
        if paragraph.strip():
            # Replace single line breaks with <br>
            formatted_paragraph = paragraph.strip().replace('\n', '<br>')
            formatted_text += f"<p>{formatted_paragraph}</p>\n"

    return formatted_text

# Error handlers
@app.errorhandler(404)
def not_found_error(error):
    logger.warning(f'404 Error: {request.url} - {str(error)}')
    return render_template('errors/404.html'), 404

@app.errorhandler(500)
def internal_error(error):
    logger.error(f'500 Error: {str(error)}')
    return render_template('errors/500.html'), 500

@app.errorhandler(Exception)
def handle_exception(error):
    logger.error(f'Unhandled Exception: {str(error)}', exc_info=True)
    return render_template('errors/500.html'), 500

@app.route('/static/<path:filename>')
def static_files(filename):
    return send_from_directory(app.static_folder, filename)

@app.route('/')
@cache.cached(timeout=300, key_prefix='index')
def index():
    """Главная страница"""
    logger.info('Index page accessed')
    return render_template('index.html')

@app.route('/specialists')
@cache.cached(timeout=300, key_prefix='specialists_list')
def specialists_list():
    """Страница всех специалистов"""
    logger.info('Specialists list page accessed')
    specialists_list = list(SPECIALISTS.values())
    return render_template('specialists.html', specialists=specialists_list)

@app.route('/specialist/<specialist_id>')
@cache.cached(timeout=600, query_string=False)
def specialist_detail(specialist_id):
    """Детальная страница специалиста"""
    logger.info(f'Specialist detail page accessed: {specialist_id}')

    try:
        if specialist_id not in SPECIALISTS:
            logger.warning(f'Specialist not found: {specialist_id}')
            raise NotFound()

        specialist = SPECIALISTS[specialist_id]

        # Process text data for better formatting
        if 'description' in specialist:
            # For Ershova, we need to extract the shorter description for display
            if specialist_id == 'ershova-yuliya-gennadievna':
                specialist['short_description'] = "Меня зовут Ершова Юлия. Я врач-психиатр, психотерапевт со опытом работы более 15 лет."
            else:
                # For other specialists, use first paragraph as short description
                paragraphs = specialist.get('description', '').split('</p>')
                if paragraphs and paragraphs[0]:
                    short_desc = paragraphs[0].replace('<p>', '').replace('<br>', '').strip()
                    specialist['short_description'] = short_desc if len(short_desc) < 200 else short_desc[:197] + "..."

        return render_template('specialist.html', specialist=specialist)

    except Exception as e:
        logger.error(f'Error in specialist_detail for {specialist_id}: {str(e)}', exc_info=True)
        raise

# ============================================
# AJAX API ENDPOINTS
# ============================================

@app.route('/api/specialists')
@cache.cached(timeout=300, key_prefix='api_specialists')
def api_specialists():
    """API: Получить список всех специалистов"""
    logger.info('API: Specialists list requested')
    specialists_list = list(SPECIALISTS.values())
    return jsonify({
        'success': True,
        'data': specialists_list,
        'count': len(specialists_list)
    })

@app.route('/api/specialist/<specialist_id>')
@cache.cached(timeout=600, query_string=False)
def api_specialist_detail(specialist_id):
    """API: Получить детальную информацию о специалисте"""
    logger.info(f'API: Specialist detail requested: {specialist_id}')

    try:
        if specialist_id not in SPECIALISTS:
            logger.warning(f'API: Specialist not found: {specialist_id}')
            return jsonify({
                'success': False,
                'error': 'Specialist not found'
            }), 404

        specialist = SPECIALISTS[specialist_id]
        return jsonify({
            'success': True,
            'data': specialist
        })

    except Exception as e:
        logger.error(f'API: Error in specialist_detail for {specialist_id}: {str(e)}', exc_info=True)
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

if __name__ == '__main__':
    app.run(
        debug=app.config['DEBUG'],
        host=app.config['HOST'],
        port=app.config['PORT']
    )